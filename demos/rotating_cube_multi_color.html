<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Colored ASCII Cube</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body {
            background: black;
            color: white;
            font-family: monospace;
            white-space: pre;
            font-size: 12px;
            line-height: 10px;
        }
    </style>
</head>
<body>
<div id="inputs">
<input type="hidden" id="cube-size" max="100" value=35 size="24">
<!-- <div>
<label for="cube-size">Cube Size</label><br>
<input type="number" id="cube-size" max="100" value=35 size="24">
</div> -->
<div>
<label for="cube-character">Character</label><br>
<input type="text" id="cube-character" minlength="1" maxlength="1" value="+" size="20">
</div>

<div>
<label for="cube-font-size">Font Size</label><br>
<input type="number" id="cube-font-size" max="100" value=10 size="24">
</div>

<div>
<label for="cube-speed">Rotation Speed</label><br>
<input type="range" id="cube-speed" min="0" max="50" value="4"><span id="cube-speed-text">4</span>
<button id="decrease-button">-</button><button id="increase-button">+</button><button id="increment-button">step</button>
</div>

<div>
<label for="cube-speed">Saturation/Lightness</label><br>
<input type="number" id="cube-saturation" min="0" max="100" value="100"><input type="number" id="cube-lightness" min="0" max="100" value="60">
</div>

<div><button id="randomize-font-color-button">Random Face Colors</button></div>

<div><button id="reset-button">Reset</button></div>
</div>

<pre id="canvas" class="overflow-hidden"></pre>

<script>
    const speedDefault = 4;
    const heightDefault = 35;
    const fontSizeDefault = 12;
    const ratio = 10/fontSizeDefault;
    const hueDefault = 360;
    const saturationDefault = 100;
    const lightnessDefault = 60;
    const characterDefault = '+';
    const face1colorDefault = "#FF0000"; // red
    const face2colorDefault = "#FFA500"; // orange
    const face3colorDefault = "#FFFF00"; // yellow
    const face4colorDefault = "#008000"; // green
    const face5colorDefault = "#1E90FF"; // dodgerblue
    const face6colorDefault = "#6A5ACD"; // slateblue/purple

    const canvas = document.getElementById("canvas");
    const speedText = document.getElementById("cube-speed-text");
    
    let angleA = 0; 
    let angleB = 0;

    // Listeners

    // Cube hsl
    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }

    function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;

        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;

        if (max === min) {
            h = s = 0; // achromatic
        } else {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }

        return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
    }

    function hexToHue(hex) {
        const { r, g, b } = hexToRgb(hex);
        const hsl = rgbToHsl(r, g, b);
        return hsl[0]; // Hue is the first element
    }

    let saturation = saturationDefault;
    let lightness = lightnessDefault;

    let face1colorHex = face1colorDefault;
    let face2colorHex = face2colorDefault;
    let face3colorHex = face3colorDefault;
    let face4colorHex = face4colorDefault;
    let face5colorHex = face5colorDefault;
    let face6colorHex = face6colorDefault;

    const cubeSaturationEl = document.getElementById("cube-saturation");
    cubeSaturationEl.value = saturationDefault;
    cubeSaturationEl.addEventListener("change", function(e) {
        e.preventDefault();

        const tempSaturation = parseInt(cubeSaturationEl.value);
        if (tempSaturation > 100) {
            cubeSaturationEl.value = saturationDefault;
        }
        saturation = parseInt(cubeSaturationEl.value);

        face1color = hslToHex(hexToHue(face1colorHex), saturation, lightness);
        face2color = hslToHex(hexToHue(face2colorHex), saturation, lightness);
        face3color = hslToHex(hexToHue(face3colorHex), saturation, lightness);
        face4color = hslToHex(hexToHue(face4colorHex), saturation, lightness);
        face5color = hslToHex(hexToHue(face5colorHex), saturation, lightness);
        face6color = hslToHex(hexToHue(face6colorHex), saturation, lightness);
    }, false);

    const cubeLightnessEl = document.getElementById("cube-lightness");
    cubeLightnessEl.value = lightnessDefault;
    cubeLightnessEl.addEventListener("change", function(e) {
        e.preventDefault();

        const tempLightness = parseInt(cubeLightnessEl.value);
        if (tempLightness > 100) {
            cubeLightnessEl.value = lightnessDefault;
        }
        lightness = parseInt(cubeLightnessEl.value);

        face1color = hslToHex(hexToHue(face1colorHex), saturation, lightness);
        face2color = hslToHex(hexToHue(face2colorHex), saturation, lightness);
        face3color = hslToHex(hexToHue(face3colorHex), saturation, lightness);
        face4color = hslToHex(hexToHue(face4colorHex), saturation, lightness);
        face5color = hslToHex(hexToHue(face5colorHex), saturation, lightness);
        face6color = hslToHex(hexToHue(face6colorHex), saturation, lightness);
    }, false);

    function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
    }

    function getBrightRandomHexColorHSL(hueValue = hueDefault, saturationValue = saturationDefault, lightnessValue = lightnessDefault) {
        return hslToHex(Math.floor(Math.random() * hueValue), saturationValue, lightnessValue);
    }

    // Randomize color
    let face1color = face1colorDefault;
    let face2color = face2colorDefault;
    let face3color = face3colorDefault;
    let face4color = face4colorDefault;
    let face5color = face5colorDefault;
    let face6color = face6colorDefault;
    const fontColorEl = document.getElementById("randomize-font-color-button");
    fontColorEl.addEventListener("click", function(e) {
        e.preventDefault();

        face1color = getBrightRandomHexColorHSL(361, saturation, lightness);
        face1colorHex = face1color;
        face2color = getBrightRandomHexColorHSL(361, saturation, lightness);
        face2colorHex = face2color;
        face3color = getBrightRandomHexColorHSL(361, saturation, lightness);
        face3colorHex = face3color;
        face4color = getBrightRandomHexColorHSL(361, saturation, lightness);
        face4colorHex = face4color;
        face5color = getBrightRandomHexColorHSL(361, saturation, lightness);
        face5colorHex = face5color;
        face6color = getBrightRandomHexColorHSL(36, saturation, lightness);
        face6colorHex = face6color;
    }, false);

    // Speed picker
    let speed = speedDefault/100;
    const speedPickerEl = document.getElementById("cube-speed");
    speedPickerEl.value = speedDefault;
    speedPickerEl.addEventListener("input", function(e) {
        e.preventDefault();

        speedText.textContent = parseInt(speedPickerEl.value);
        speed = parseInt(speedPickerEl.value)/100;
    }, false);

    const decreaseSpeedEl = document.getElementById("decrease-button");
    decreaseSpeedEl.addEventListener("click", function(e) {
        e.preventDefault();

        const currentSpeed = parseInt(speedPickerEl.value);
        if (currentSpeed > 0) {
            speedPickerEl.value = parseInt(speedPickerEl.value) - 1;
            speedText.textContent = parseInt(speedPickerEl.value);
            speed = parseInt(speedPickerEl.value)/100;
        }
    }, false);

    const increaseSpeedEl = document.getElementById("increase-button");
    increaseSpeedEl.addEventListener("click", function(e) {
        e.preventDefault();

        const currentSpeed = parseInt(speedPickerEl.value);
        if (currentSpeed < 50) {
            speedPickerEl.value = parseInt(speedPickerEl.value) + 1;
            speedText.textContent = parseInt(speedPickerEl.value);
            speed = parseInt(speedPickerEl.value)/100;
        }
    }, false);

    const incrementSpeedEl = document.getElementById("increment-button");
    incrementSpeedEl.addEventListener("click", function(e) {
        e.preventDefault();

        speedPickerEl.value = 0;
        speedText.textContent = 0;
        speed = 0.01;
        setTimeout(() => {
            speed = 0;
        }, 0);
    }, false);

    // Cube size picker
    let height = heightDefault;
    let width = height*1.4;
    const cubeSizeEl = document.getElementById("cube-size");
    cubeSizeEl.value = heightDefault;
    cubeSizeEl.addEventListener("change", function(e) {
        e.preventDefault();

        const tempHeight = parseInt(cubeSizeEl.value);
        if (tempHeight > 100) {
            cubeSizeEl.value = 100;
        }
        height = parseInt(cubeSizeEl.value);
        width = height*1.4;
    }, false);

    // Font size picker
    canvas.style.fontSize = fontSizeDefault+"px";
    canvas.style.lineHeight = (fontSizeDefault*ratio).toString()+"px";
    const cubeFontSizeEl = document.getElementById("cube-font-size");
    cubeFontSizeEl.value = fontSizeDefault;
    cubeFontSizeEl.addEventListener("change", function(e) {
        e.preventDefault();

        const tempFontSize = parseInt(cubeFontSizeEl.value);
        if (tempFontSize > 100) {
            cubeFontSizeEl.value = 100;
        } else if (tempFontSize === 0) {
            cubeFontSizeEl.value = 1;
        }
        canvas.style.fontSize = cubeFontSizeEl.value+"px";
        canvas.style.lineHeight = (cubeFontSizeEl.value*ratio).toString()+"px";

        console.log("fontSize:"+cubeFontSizeEl.value+"px");
        console.log("lineHeight:"+(cubeFontSizeEl.value*ratio).toString()+"px");
    }, false);

    // Character input
    let character = characterDefault;
    const characterPickerEl = document.getElementById("cube-character");
    characterPickerEl.value = character;
    characterPickerEl.addEventListener("input", function(e) {
        e.preventDefault();

        character = characterPickerEl.value.trim();
    }, false);

    // Reset button
    const resetButtonEl = document.getElementById("reset-button");
    resetButtonEl.addEventListener("click", function(e) {
        e.preventDefault();

        character = characterDefault;
        characterPickerEl.value = characterDefault;

        cubeFontSizeEl.value = fontSizeDefault;
        canvas.style.fontSize = fontSizeDefault+"px";
        canvas.style.lineHeight = (fontSizeDefault*ratio).toString()+"px";

        speedPickerEl.value = speedDefault;
        const speedText = document.getElementById("cube-speed-text");
        speedText.textContent = speedDefault;
        speed = speedDefault/100;

        cubeSizeEl.value = heightDefault;
        height = heightDefault;
        width = height*1.4;

        saturation = saturationDefault;
        lightness = lightnessDefault;
        cubeSaturationEl.value = saturationDefault;
        cubeLightnessEl.value = lightnessDefault;
        
        face1color = face1colorDefault;
        face2color = face2colorDefault;
        face3color = face3colorDefault;
        face4color = face4colorDefault;
        face5color = face5colorDefault;
        face6color = face6colorDefault;

    }, false);

    document.addEventListener('keydown', (event) => {
        const keyCode = event.keyCode;

        if (document.activeElement !== characterPickerEl) {
            if (keyCode === 27) { // esc - reset
                resetButtonEl.click();
            } else if (keyCode === 38 || keyCode === 87) { // up or w - increase font size
                if (cubeFontSizeEl.value === "") {
                    cubeFontSizeEl.value = fontSizeDefault;
                }
                cubeFontSizeEl.value = parseInt(cubeFontSizeEl.value) + 1;
                const tempFontSize = parseInt(cubeFontSizeEl.value);
                if (tempFontSize > 100) {
                    cubeFontSizeEl.value = 100;
                }
                canvas.style.fontSize = cubeFontSizeEl.value+"px";
                canvas.style.lineHeight = (cubeFontSizeEl.value*ratio).toString()+"px";
            } else if (keyCode === 40 || keyCode === 83) { // down or s - decrease font size
                if (cubeFontSizeEl.value === "") {
                    cubeFontSizeEl.value = fontSizeDefault;
                }
                cubeFontSizeEl.value = parseInt(cubeFontSizeEl.value) - 1;
                const tempFontSize = parseInt(cubeFontSizeEl.value);
                if (tempFontSize === 0) {
                    cubeFontSizeEl.value = 1;
                }
                canvas.style.fontSize = cubeFontSizeEl.value+"px";
                canvas.style.lineHeight = (cubeFontSizeEl.value*ratio).toString()+"px";
            } else if (keyCode === 39 || keyCode === 68) { // right or d - increase speed
                const currentSpeed = parseInt(speedPickerEl.value);
                if (currentSpeed < 50) {
                    speedPickerEl.value = parseInt(speedPickerEl.value) + 1;
                    speedText.textContent = parseInt(speedPickerEl.value);
                    speed = parseInt(speedPickerEl.value)/100;
                }
            } else if (keyCode === 37 || keyCode === 65) { // left or a - decrease speed
                const currentSpeed = parseInt(speedPickerEl.value);
                if (currentSpeed > 0) {
                    speedPickerEl.value = parseInt(speedPickerEl.value) - 1;
                    speedText.textContent = parseInt(speedPickerEl.value);
                    speed = parseInt(speedPickerEl.value)/100;
                }
            } else if (keyCode === 32) { // space - pause
                speedPickerEl.value = 0;
                speedText.textContent = 0;
                speed = 0;
            } else if (keyCode === 82) { // r - random color
                fontColorEl.click();
            } else if (keyCode === 73) { // i - increment frame
                speedPickerEl.value = 0;
                speedText.textContent = 0;
                speed = 0.01;
                setTimeout(() => {
                    speed = 0;
                }, 0);
            }
        } else {
            characterPickerEl.value = event.key.trim().charAt(0);
            character = event.key.trim().charAt(0);
        }
    });

    function renderFrame() {
        const z = Array(width * height).fill(0);
        const b = Array(width * height).fill(' ');
        const color = Array(width * height).fill('');

        function plot(x, y, zVal, ch, faceClass) {
            const xp = Math.floor(width / 2 + x);
            const yp = Math.floor(height / 2 - y);
            const idx = xp + width * yp;
            if (xp >= 0 && xp < width && yp >= 0 && yp < height && zVal > z[idx]) {
                z[idx] = zVal;
                b[idx] = ch;
                color[idx] = faceClass;
            }
        }

        // Cube vertices
        const vertices = [
            [-1, -1, -1], [1, -1, -1],
            [1,  1, -1], [-1, 1, -1],
            [-1, -1,  1], [1, -1,  1],
            [1,  1,  1], [-1, 1,  1]
        ];

        // Cube faces (each face has four vertex indices)
        const faces = [
            [0, 1, 2, 3, 'face1'],
            [4, 5, 6, 7, 'face2'],
            [0, 1, 5, 4, 'face3'],
            [2, 3, 7, 6, 'face4'],
            [0, 3, 7, 4, 'face5'],
            [1, 2, 6, 5, 'face6']
        ];

        function rotate(x, y, z) {
            const sinA = Math.sin(angleA), cosA = Math.cos(angleA);
            const sinB = Math.sin(angleB), cosB = Math.cos(angleB);
            let x1 = x * cosB - z * sinB;
            let z1 = x * sinB + z * cosB;
            let y1 = y * cosA - z1 * sinA;
            z1 = y * sinA + z1 * cosA;
            return [x1, y1, z1 + 4]; // Z offset for perspective
        }

        for (const [a, b, c, d, faceClass] of faces) {
            const v = [vertices[a], vertices[b], vertices[c], vertices[d]].map(p => rotate(...p));
            const steps = 10;
            for (let i = 0; i <= steps; i++) {
                for (let j = 0; j <= steps; j++) {
                    const x = (v[0][0] * (1 - i / steps) + v[1][0] * (i / steps)) * (1 - j / steps)
                            + (v[3][0] * (1 - i / steps) + v[2][0] * (i / steps)) * (j / steps);
                    const y = (v[0][1] * (1 - i / steps) + v[1][1] * (i / steps)) * (1 - j / steps)
                            + (v[3][1] * (1 - i / steps) + v[2][1] * (i / steps)) * (j / steps);
                    const zVal = (v[0][2] * (1 - i / steps) + v[1][2] * (i / steps)) * (1 - j / steps)
                            + (v[3][2] * (1 - i / steps) + v[2][2] * (i / steps)) * (j / steps);
                    plot(x * 15, y * 10, 1 / zVal, character, faceClass);
                }
            }
        }

        let frame = '';
        for (let i = 0; i < b.length; i++) {
            if (i % width === 0) {
                frame += '\n';
            }
            
            const cls = color[i];
            let fontColor = "";
            if (cls === "face1") {
                fontColor = face1color;
            } else if (cls === "face2") {
                fontColor = face2color;
            } else if (cls === "face3") {
                fontColor = face3color;
            } else if (cls === "face4") {
                fontColor = face4color;
            } else if (cls === "face5") {
                fontColor = face5color;
            } else if (cls === "face6") {
                fontColor = face6color;
            }

            frame += cls ? `<span class="${cls}" style="color: ${fontColor}">${b[i]}</span>` : b[i];
        }

        canvas.innerHTML = frame;
        angleA += (speed === 0) ? 0 : ((speed === 0.01) ? 0.008 : speed-0.01);
        angleB += (speed === 0) ? 0 : ((speed === 0.01) ? 0.009 : speed);
        requestAnimationFrame(renderFrame);
    }

    renderFrame();
</script>

</body>
</html>